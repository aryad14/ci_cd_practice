version: "3.9"

services:
  ####################################################
  # USERS SERVICE (FASTAPI)
  ####################################################
  users_service:
    build:
      context: ./services/users_service
    container_name: users_service
    env_file:
      - ./services/users_service/.env
    depends_on:
      - users-db
    command: ["uvicorn", "app.main:app", "--host", "0.0.0.0"]
    ports:
      - "8000:8000"

  ####################################################
  # USERS DATABASE
  ####################################################
  users-db:
    image: mysql:8
    container_name: users-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: usersdb
    volumes:
      - users_db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin","ping","-h","localhost"]
      interval: 5s
      timeout: 3s
      retries: 10

  ####################################################
  # ORDERS SERVICE (SPRING BOOT)
  ####################################################
  orders_service:
    build:
      context: ./services/orders_service
    container_name: orders_service
    environment:
      SPRING_DATASOURCE_URL: jdbc:mysql://orders-db:3306/ordersdb
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: root
    depends_on:
      - orders-db
    expose:
      - "8080:8080"

  ####################################################
  # ORDERS DATABASE
  ####################################################
  orders-db:
    image: mysql:8
    container_name: orders-db
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: ordersdb
    volumes:
      - orders_db_data:/var/lib/mysql
    healthcheck:
      test: ["CMD", "mysqladmin","ping","-h","localhost"]
      interval: 5s
      timeout: 3s
      retries: 10

  ####################################################
  # FRONTEND (STATIC SERVED BY NGINX)
  ####################################################
  frontend:
    build:
      context: ./www
      target: prod
    container_name: frontend
    ports:
      - "3000:80"
    depends_on:
      - users_service
      - orders_service

####################################################
# VOLUMES
####################################################
volumes:
  users_db_data:
  orders_db_data:
